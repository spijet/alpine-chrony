---
stages:
  - test

test_simple:
  stage: test
  image: dockage/alpine:3.11-openrc
  tags:
    - minipig
  variables:
    ANSIBLE_CONFIG: "${PWD}/ansible.cfg"
  before_script:
    - apk add -U ansible
    - ansible --version
    - printf "[defaults]\nroles_path = $(dirname ${PWD})\n" > "${ANSIBLE_CONFIG}"
    - mkdir /run/openrc && touch /run/openrc/softlevel
    - rc-status -a
  script:
    - ansible-playbook tests/test.yml -i tests/inventory --syntax-check
    - ansible-playbook tests/test.yml -i tests/inventory --connection local

test_molecule:
  stage: test
  image: docker:stable
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  tags:
    - minipig
  before_script:
    - apk add -U ansible py3-pip docker-py
    - python3 -m pip install molecule[docker]
    - ansible --version
    - molecule --version
    - docker info
  script:
    - molecule test --driver-name=docker --destroy=always
